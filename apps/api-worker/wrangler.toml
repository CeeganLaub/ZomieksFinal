name = "zomieks-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

account_id = "1842cd01813277b018d4172a14a00f17"

# Custom domain for the API worker
routes = [
  { pattern = "api.zomieks.com", custom_domain = true }
]

# Development settings
[dev]
port = 8787
local_protocol = "http"

# Environment variables (secrets should be set via wrangler secret put)
[vars]
ENVIRONMENT = "production"
APP_URL = "https://www.zomieks.com"
FRONTEND_URL = "https://www.zomieks.com"
CDN_URL = ""
PAYFAST_SANDBOX = "false"
OZOW_TEST_MODE = "false"

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "zomieks-db"
database_id = "8667321c-8a98-4000-99af-4583257cd229"
migrations_dir = "../../packages/db/migrations"

# KV Namespaces
[[kv_namespaces]]
binding = "CACHE"
id = "d397483c29b94ee6a33c7665863d03c3"

[[kv_namespaces]]
binding = "SESSIONS"
id = "590bdb3acba74ba98610217652a03715"

[[kv_namespaces]]
binding = "RATE_LIMIT"
id = "94732323e8d64e3da23b8392c879012b"

# R2 Storage
[[r2_buckets]]
binding = "UPLOADS"
bucket_name = "zomieks-uploads"

# Queues - Producers
[[queues.producers]]
queue = "zomieks-escrow-queue"
binding = "ESCROW_QUEUE"

[[queues.producers]]
queue = "zomieks-notification-queue"
binding = "NOTIFICATION_QUEUE"

[[queues.producers]]
queue = "zomieks-email-queue"
binding = "EMAIL_QUEUE"

# Queues - Consumers
[[queues.consumers]]
queue = "zomieks-escrow-queue"
max_batch_size = 10
max_batch_timeout = 30

[[queues.consumers]]
queue = "zomieks-notification-queue"
max_batch_size = 50
max_batch_timeout = 10

[[queues.consumers]]
queue = "zomieks-email-queue"
max_batch_size = 20
max_batch_timeout = 30

# Durable Objects
[[durable_objects.bindings]]
name = "CHAT_ROOMS"
class_name = "ChatRoom"

[[durable_objects.bindings]]
name = "PRESENCE"
class_name = "Presence"

[[durable_objects.bindings]]
name = "CRM_NOTIFICATIONS"
class_name = "CrmNotifications"

# Durable Object migrations (free plan requires new_sqlite_classes)
[[migrations]]
tag = "v1"
new_sqlite_classes = ["ChatRoom", "Presence", "CrmNotifications"]

# Email sending via Resend
# Set RESEND_API_KEY via: wrangler secret put RESEND_API_KEY

# Secrets (set via: wrangler secret put SECRET_NAME)
# Required secrets:
# - JWT_SECRET
# - RESEND_API_KEY
# - PAYFAST_MERCHANT_ID
# - PAYFAST_MERCHANT_KEY
# - PAYFAST_PASSPHRASE
# - OZOW_SITE_CODE
# - OZOW_PRIVATE_KEY
